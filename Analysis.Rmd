---
title: "Policy Amend Analysis"
author: "Eli"
date: "21/09/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#### Importing libraries
```{r message=FALSE, warning=FALSE}
source("utils/loadpackages.R")
```

#### Reading data 
```{r warning=FALSE, message=FALSE}
data <- read_excel("NCdata.xlsx", sheet = "PERCENT", range = cell_rows(1:98))
```

#### Renaming column 1
```{r warning=FALSE, message=FALSE}
names(data)[names(data) == names(data)[1]] <- "City"
```


```{r warning=FALSE, message=FALSE}
data
```

#### Converting City names to Longitude and latitude
```{r warning=FALSE, message=FALSE}
library(tidygeocoder)
library(ggmap) # for register_google function/ masks tidygeocoder
```


Source: https://www.youtube.com/watch?v=OGTG1l7yin4 (Google Maps API video)

STEPS to get API
1. goto: https://console.cloud.google.com/
2. Create project (dropdown option on the right of Google Cloud Platform)
3. Give project a name, then create. 
4. Switch to project 
5. Click sidepar option and navigate to APIs & Services 
6. Search "Geocoding API" then enable API
7. Goto APIs & Services then to Credentials 
8. Click create credentials on the top bar 
9. Then click API Key, copy key someone safe
10. Click restrict key
```{r warning=FALSE, message=FALSE}
# register_google(key = Sys.getenv("GOOGLEGEOCODE_API_KEY"), write = TRUE)
geo_data <- data %>%
  tidygeocoder::geocode(City, method = 'osm', lat = latitude , long = longitude)
```


```{r warning=FALSE, message=FALSE}
library(sf)
library(mapview)
```


```{r warning=FALSE, message=FALSE}
# locations_sf <- st_as_sf(geo_data, coords = c("longitude", "latitude"), crs = 4326)
```


```{r warning=FALSE, message=FALSE}
# write.csv(geo_data, "geo_NCdata.csv")
```

#### Checking missing values
```{r warning=FALSE, message=FALSE}
sapply(geo_data, function(x) sum(is.na(x)))
```

#### Rows with missing data
- City Not recognized by Google 
- City spelled incorrectly 
- Cities not recognised by map
```{r warning=FALSE, message=FALSE}
geo_data[rowSums(is.na(geo_data)) > 0,]
```

##### Remove missing data
```{r warning=FALSE, message=FALSE}
locations_df <- subset(geo_data, !is.na(geo_data$longitude) & !is.na(geo_data$latitude))
```


```{r warning=FALSE, message=FALSE}
locations_sf <- st_as_sf(locations_df, coords = c("longitude", "latitude"), crs = 4326)
```

#### Map the locations recognised on Google
- Source: https://www.jessesadler.com/post/geocoding-with-r/
- Source2: https://cran.r-project.org/web/packages/tidygeocoder/readme/README.html
```{r warning=FALSE, message=FALSE}
mapview(locations_sf)
```

#### Geocoding using ggmap
- mutate_geocode() function will not work on tibbles
- convert tibble to dataframe
- using ggmap library
- Requires billing 
```{r warning=FALSE, message=FALSE}
# cities_df <- as.data.frame(data)
# register_google(key = Sys.getenv("GOOGLEGEOCODE_API_KEY"), write = TRUE)
# locations_gmdf <- mutate_geocode(cities_df, City)
```

#### Working with MAP View
Source: https://r-spatial.github.io/mapview/articles/articles/mapview_02-advanced.html
Source2: https://bookdown.org/nicohahn/making_maps_with_r5/docs/mapview.html
```{r warning=FALSE, message=FALSE}
clust_gdata <- locations_df
clust_gdata$Group <-sample(rep(c("Cluster 1", "Cluster 2", "Cluster 3"),
                               length.out = nrow(locations_df)),
       size = nrow(locations_df))
```


```{r warning=FALSE, message=FALSE}
clust_sf <- st_as_sf(clust_gdata, coords = c("longitude", "latitude"), crs = 4326)
```


#### Viewing Mapview according to clusters
```{r warning=FALSE, message=FALSE}
library(leaflet)
library(leafpop)
```


```{r warning=FALSE, message=FALSE}
mapview(clust_sf,
        zcol = "Group",
        popup = popupTable(
          clust_sf,
          zcol = c("City",
                   "Natural Resources")
        ))
```


```{r warning=FALSE, message=FALSE}
library(RColorBrewer)
```


#### Trying to narrow to northern cape
```{r warning=FALSE, message=FALSE}
data$City
```


```{r warning=FALSE, message=FALSE}
geo(
  state = "Northern Cape", method = "osm",
  lat = latitude, long = longitude
)
```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```


```{r warning=FALSE, message=FALSE}

```



